<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT LIST - UN-DESIGN</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;600&family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --glass: rgba(255, 255, 255, 0.1); --accent: #e6c25e; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', 'Noto Serif JP', serif; color: #fff; background: #0a0a0a; min-height: 100vh; padding-bottom: 120px; transition: opacity 0.5s ease; }
        
        @keyframes bgFadeIn { from { opacity: 0; transform: scale(1.05); } to { opacity: 1; transform: scale(1); } }
        .bg-fixed { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.85)), url('https://picsum.photos/id/1011/1920/1080'); background-size: cover; z-index: -1; 
            opacity: 0; animation: bgFadeIn 1.5s ease-out forwards;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 80px 20px 40px; }
        h1 { font-size: 3rem; letter-spacing: 0.3em; color: var(--accent); margin-bottom: 50px; text-align: center; }

        /* ステータスバー */
        .status-bar { 
            position: fixed; top: 0; left: 0; width: 100%; padding: 15px; 
            text-align: center; z-index: 1000; font-weight: bold; font-size: 1.1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6); transition: 0.4s;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .projects-grid {
            display: grid; grid-template-columns: 1fr; gap: 40px;
            margin-bottom: 40px;
        }

        .proposal-card { 
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); border-top: 1px solid rgba(255,255,255,0.2); border-left: 1px solid rgba(255,255,255,0.2);
            border-radius: 25px; padding: 20px; position: relative; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            display: flex; flex-direction: column; height: auto; /* 固定高さ削除 */
            transition: 0.3s; overflow: hidden;
        }
        .proposal-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.5); border-color: rgba(230, 194, 94, 0.5); }

        /* ヘッダー (タイトル + 誰から誰に) */
        .card-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
            flex-wrap: wrap;
        }
        .header-vector {
            display: flex; align-items: center; gap: 15px; font-family: 'Noto Sans JP', sans-serif;
        }
        .vector-item { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        /* .vector-lbl { font-size: 0.7rem; opacity: 0.5; letter-spacing: 0.1em; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; } */
        .vector-arrow { opacity: 0.3; font-size: 1.2rem; }
        /* 3カラムレイアウト (提案・問題・効果) */
        .card-body-grid {
            display: grid; grid-template-columns: 1.2fr 1fr 1fr; gap: 20px;
            margin-bottom: 15px;
        }
        .body-col {
            background: rgba(255,255,255,0.02); padding: 15px; border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .col-label {
            display: block; font-size: 0.75rem; opacity: 0.5; letter-spacing: 0.1em; margin-bottom: 15px; text-transform: uppercase;
        }
        
        .icon-box { display: flex; gap: 15px; }
        .icon-svg { width: 24px; height: 24px; flex-shrink: 0; margin-top: 2px; }
        .negative-icon { color: #ff4d4d; }
        .positive-icon { color: #e6c25e; }

        .card-footer { display: flex; align-items: flex-end; gap: 20px; }
        .cost-gauge-container { flex-grow: 1; margin-bottom: 0; }
        .cost-gauge-row { display: flex; align-items: center; margin-bottom: 8px; }
        .cost-gauge-row .cost-name { width: 140px; font-size: 0.8rem; opacity: 0.7; letter-spacing: 0.05em; }
        .gauge-track { 
            flex-grow: 1; height: 8px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; 
            /* 100pt (20%) ごとに目盛り線を表示 */
            background-image: linear-gradient(to right, rgba(255,255,255,0.3) 1px, transparent 1px);
            background-size: 20% 100%;
        }
        .gauge-bar { height: 100%; border-radius: 3px; }
        .gauge-bar.type-1 { background: #fff59d; }
        .gauge-bar.type-2 { background: #fff59d; }
        .gauge-bar.type-3 { background: #fff59d; }

        h2 { font-family: 'Noto Sans JP', sans-serif; font-size: 1.8rem; margin: 0; color: #fff; line-height: 1.2; }
        .main-details { margin: 0; font-size: 1.05rem; line-height: 1.8; font-family: 'Noto Sans JP', sans-serif; opacity: 0.95; }
        .content-text { font-size: 1rem; margin-bottom: 0; line-height: 1.7; opacity: 0.9; font-family: 'Noto Sans JP', sans-serif; }

        /* ポイント入力 */
        .point-input-area { 
            background: rgba(255,255,255,0.05); padding: 10px; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; gap: 5px; border: 1px solid rgba(255,255,255,0.1);
            width: 150px; flex-shrink: 0;
        }
        .point-input { 
            width: 100%; background: #000; border: 2px solid #fff; color: #fff; font-family: 'Noto Sans JP', sans-serif;
            padding: 5px; text-align: center; font-size: 1.2rem; border-radius: 8px; 
        }

        .btn-submit-all { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 22px 70px; background: #fff; color: #000; font-weight: 700;
            border: none; border-radius: 50px; cursor: not-allowed; opacity: 0.2;
            transition: 0.4s; z-index: 1000; letter-spacing: 0.2em;
        }
        .btn-submit-all.ready { cursor: pointer; opacity: 1; transform: translateX(-50%) scale(1.05); box-shadow: 0 10px 40px rgba(255,255,255,0.4); }

        .nav-links { text-align: center; margin-top: 50px; }
        .nav-links a { color: rgba(255,255,255,0.7); text-decoration: none; margin: 0 15px; font-size: 1rem; transition: 0.3s; letter-spacing: 0.1em; }
        .nav-links a:hover { color: #fff; }

        @media (max-width: 768px) {
            .proposal-card { height: auto; }
            .card-body-grid { grid-template-columns: 1fr; }
            .card-header { flex-direction: column; align-items: flex-start; }
        }

        .page-loader {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 9999;
            animation: fadeOutLoader 1.2s ease-out 0.5s forwards;
        }
        @keyframes fadeOutLoader {
            to { opacity: 0; pointer-events: none; }
        }
    </style>
</head>
<body>
    <div class="page-loader"></div>
    <div class="bg-fixed"></div>
    
    <div id="status-bar" class="status-bar" style="background: {{ 'rgba(255,68,68,0.95)' if has_voted else 'rgba(255,255,255,0.95)' }}; color: {{ '#fff' if has_voted else '#000' }};">
        {% if has_voted %}
            VOTED: 100PTの割り振りを完了しています
        {% else %}
            REMAINING: <span id="remain-pts">1000</span> PT / 1000 PT
        {% endif %}
    </div>

    <div class="container">
        <h1>PROJECTS</h1>

        <form id="voteForm" action="{{ url_for('un_design.vote_all') }}" method="POST">
            <div class="projects-grid">
            {% for proposal in proposals %}
            <div class="proposal-card">
                {% set pct = (proposal.total_points / proposal.target_cost * 100)|round|int if proposal.target_cost > 0 else 0 %}
                
                <!-- ヘッダー: タイトル + 誰から誰に -->
                <div class="card-header">
                    <h2>{{ proposal.title }}</h2>
                    <div class="header-vector">
                        <span class="vector-item">{{ proposal.author }}</span>
                        <span class="vector-arrow">→</span>
                        <span class="vector-item">{{ proposal.target }}</span>
                    </div>
                </div>

                <!-- 3カラム: 提案内容 / 問題点 / 効果 -->
                <div class="card-body-grid">
                    <div class="body-col">
                        <p class="main-details">{{ proposal.details }}</p>
                    </div>
                    <div class="body-col">
                        <div class="icon-box">
                            <svg class="icon-svg negative-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 2.5c-2.33 0-4.31 1.46-5.11 3.5h10.22c-.8-2.04-2.78-3.5-5.11-3.5z"/></svg>
                            <p class="content-text">{{ proposal.problem }}</p>
                        </div>
                    </div>
                    <div class="body-col">
                        <div class="icon-box">
                            <svg class="icon-svg positive-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 5.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>
                            <p class="content-text">{{ proposal.effect }}</p>
                        </div>
                    </div>
                </div>

                <div class="card-footer">
                    <!-- Cost Gauge -->
                    <div class="cost-gauge-container">
                        {% for item_name, item_val in proposal.costs %}
                        <div class="cost-gauge-row">
                            <span class="cost-name">{{ item_name }}</span>
                            <div class="gauge-track">
                                <div class="gauge-bar type-{{ loop.index }}" style="width: {{ (item_val / 500 * 100) if (item_val / 500 * 100) <= 100 else 100 }}%;"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if not has_voted %}
                        {% if proposal.creator_id|string == session['voter_id']|string %}
                        <div class="point-input-area" style="background: transparent; border: none; width: auto; flex-direction: row; gap: 10px;">
                            <a href="{{ url_for('un_design.edit_proposal', id=proposal.id) }}" style="color: var(--accent); text-decoration: none; border: 1px solid var(--accent); padding: 10px 20px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; display: inline-block; transition: 0.3s;">EDIT</a>
                            <a href="{{ url_for('un_design.delete_proposal', id=proposal.id) }}" onclick="return confirm('本当に削除しますか？');" style="color: #ff4d4d; text-decoration: none; border: 1px solid #ff4d4d; padding: 10px 20px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; display: inline-block; transition: 0.3s;">DELETE</a>
                        </div>
                        {% else %}
                        <div class="point-input-area">
                            <label style="font-size: 0.6rem; font-weight: 600; white-space: nowrap;">VOTE (0-1000)</label>
                            <input type="number" name="points_{{ proposal.id }}" 
                                   class="point-input pt-field" value="0" min="0" max="1000" onchange="if(this.value<0)this.value=0;">
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            </div>

            {% if not has_voted %}
                <button type="submit" id="submitBtn" class="btn-submit-all" disabled>1000PTを割り振ってください</button>
            {% endif %}
        </form>

        <div class="nav-links">
            <a href="{{ url_for('un_design.menu') }}">BACK TO MENU</a>
            <a href="{{ url_for('un_design.result') }}">STATISTICS</a>
            <a href="{{ url_for('un_design.logout') }}">LOGOUT</a>
        </div>
    </div>

    <script>
        const fields = document.querySelectorAll('.pt-field');
        const remainDisplay = document.getElementById('remain-pts');
        const submitBtn = document.getElementById('submitBtn');
        const statusBar = document.getElementById('status-bar');

        function updatePoints() {
            if (!fields.length) return;
            let totalAllocated = 0;
            fields.forEach(f => { totalAllocated += parseInt(f.value || 0); });
            const remaining = 1000 - totalAllocated;
            if (remainDisplay) remainDisplay.innerText = Math.max(0, remaining);

            if (remaining === 0) {
                submitBtn.classList.add('ready');
                submitBtn.disabled = false;
                submitBtn.innerText = "投票を確定する";
                statusBar.style.background = "#2ecc71"; statusBar.style.color = "#000";
            } else if (remaining < 0) {
                submitBtn.classList.remove('ready');
                submitBtn.disabled = true;
                submitBtn.innerText = "1000ポイントを超えています";
                statusBar.style.background = "#e74c3c"; statusBar.style.color = "#fff";
            } else {
                submitBtn.classList.remove('ready');
                submitBtn.disabled = true;
                submitBtn.innerText = `${remaining}PTを割り振ってください`;
                statusBar.style.background = "rgba(255,255,255,0.95)"; statusBar.style.color = "#000";
            }
        }
        fields.forEach(f => { f.addEventListener('input', updatePoints); });

        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', e => {
                    const href = link.getAttribute('href');
                    if (href && !href.startsWith('#') && !href.startsWith('javascript') && link.target !== '_blank') {
                        e.preventDefault();
                        document.body.style.opacity = '0';
                        setTimeout(() => window.location.href = href, 800);
                    }
                });
            });
        });
    </script>
</body>
</html>